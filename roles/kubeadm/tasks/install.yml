---

- name: Install Docker
  yum:
    name: docker
    state: latest

- name: Ensure Docker is started
  service:
    name: docker
    state: started
    enabled: yes

- name: Install Kubernetes
  yum:
    name: "{{ item }}"
    state: latest
  with_items:
    - "kubelet-{{ kubernetes_version_target }}"
    - "kubeadm-{{ kubernetes_version_target }}"
    - "kubectl-{{ kubernetes_version_target }}"

- name: Ensure kubelet is started
  service:
    name: kubelet
    state: started
    enabled: yes

# Keeping the configuration steps separate allows this to be used as a
# full-cluster playbook and a per-host playbook and ensure that the
# master gets configured first

- name: Configure host as master
  include_tasks: configure-master.yml
  when: kube_role == "master"

- name: Configure host as worker
  include_tasks: configure-worker.yml
  when: kube_role == "worker"

- name: Set installed Kubernetes version fact
  set_fact:
    kubernetes_version_installed: "{{ kubernetes_version_target }}"
