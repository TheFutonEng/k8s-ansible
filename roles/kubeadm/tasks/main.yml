---

# We only support single-master clusters
- fail:
    msg: "Exactly one master is required"
  run_once: true
  when: "groups['kube-masters']|length != 1"

# There should be no crossover between the masters and the workers
- fail:
    msg: "Masters cannot also be workers"
  when:
    - inventory_hostname in groups['kube-masters']
    - inventory_hostname in groups['kube-workers']

# Include cloud provider variables
- include_vars: "{{ cloud_provider }}.yml"
  when: cloud_provider is defined

# Get the Kubernetes version information
- include_tasks: version.yml

# Upgrade existing nodes first
# We use a trick so that only one host is upgraded at once
- include_tasks: upgrade.yml
  when:
    - inventory_hostname == host_item
    - kubernetes_version_installed is defined
    - (upgrade_packages | bool) or (upgrade_kubernetes | bool)
  # Make sure the masters are upgraded first
  with_items: "{{ groups['kube-masters']|list }} + {{ groups['kube-workers']|list }}"
  loop_control:
    loop_var: host_item

# Then install any new nodes
# This can be done in parallel
- include_tasks: install.yml
  when: kubernetes_version_installed is not defined

# The final step is to remove any nodes that are no longer in the inventory
- include_tasks: remove.yml
  when: kube_role == "master"
